{
  "hash": "23689033080e887f38de4ee9bb799c84",
  "result": {
    "markdown": "---\ndate: 2023-11-21\nlesson: Stat8\nthema: Clusteranalysen\nindex: 1\nformat:\n  html:\n    code-tools:\n      source: true\n---\n\n\n# Stat8: Demo\n\n-   Download dieses Demoscript via \"\\</\\>Code\" (oben rechts)\n-   Datensatz *Doubs.RData*\n-   Datensatz *dave_sveg.csv* von @wildi2017data\n-   Funktion drawmap.R [drawmap.R](drawmap.R)\n-   Funktion hcoplot.R [hcoplot.R](hcoplot.R)\n\n## k-means clustering\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Das Moordatenset sveg laden\nlibrary(\"readr\")\nsveg <- read_delim(\"datasets/stat5-8/dave_sveg.csv\")\n## Error: 'datasets/stat5-8/dave_sveg.csv' does not exist in current working directory ('C:/Users/luoe/Documents/Coding/Research Methods/HS23').\n\n# PCA und CA rechnen\nlibrary(\"vegan\")\npca <- rda(sveg^0.25, scale = TRUE)\n## Error in rda(sveg^0.25, scale = TRUE): object 'sveg' not found\nca <- cca(sveg^0.5)\n## Error in cca(sveg^0.5): object 'sveg' not found\n\n# k-means-Clustering mit 4 Gruppen durchfÃ¼hren\nkmeans.1 <- kmeans(sveg, 4)\n## Error in as.matrix(x): object 'sveg' not found\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Clustering-Resultat in Ordinationsplots darstellen\nplot(ca, type = \"n\")\n## Error in plot(ca, type = \"n\"): object 'ca' not found\npoints(ca, display = \"sites\", pch=19, col = kmeans.1[[1]])\n## Error in points(ca, display = \"sites\", pch = 19, col = kmeans.1[[1]]): object 'ca' not found\n\n# k-means Clustering mit 3 Clusters\nkmeans.2 <- kmeans(sveg, 3)\n## Error in as.matrix(x): object 'sveg' not found\nplot(pca, type = \"n\")\n## Error in plot(pca, type = \"n\"): object 'pca' not found\npoints(pca, display = \"sites\", pch=19, col = kmeans.2[[1]])\n## Error in points(pca, display = \"sites\", pch = 19, col = kmeans.2[[1]]): object 'pca' not found\n\n# mit 3. Achse darstellen\nplot(pca, choices = c(1, 3), type = \"n\")\n## Error in plot(pca, choices = c(1, 3), type = \"n\"): object 'pca' not found\npoints(pca, choices = c(1, 3), display = \"sites\", pch = 19, col=kmeans.2[[1]])\n## Error in points(pca, choices = c(1, 3), display = \"sites\", pch = 19, col = kmeans.2[[1]]): object 'pca' not found\n\n# k-means partitioning, 2 to 10 groups\nKM.cascade <- cascadeKM(sveg,  inf.gr = 2, sup.gr = 10, iter = 100, criterion = \"ssi\")\n## Error in as.matrix(data): object 'sveg' not found\nsummary(KM.cascade)\n## Error in summary(KM.cascade): object 'KM.cascade' not found\nKM.cascade$results\n## Error in eval(expr, envir, enclos): object 'KM.cascade' not found\nKM.cascade$partition\n## Error in eval(expr, envir, enclos): object 'KM.cascade' not found\n\n# k-means visualisation\nplot(KM.cascade, sortg = TRUE)\n## Error in plot(KM.cascade, sortg = TRUE): object 'KM.cascade' not found\n```\n:::\n\n\n## Agglomarative Clusteranalyse\n\nmit Daten und Skripten aus @borcard2011\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Daten laden\nload(\"datasets/stat5-8/Doubs.RData\")  \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Remove empty site 8\nspe <- spe[-8, ]\nenv <- env[-8, ]\nspa <- spa[-8, ]\nlatlong <- latlong[-8, ]\n```\n:::\n\n\n## Dendogramme berechnen und ploten\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Hierarchical agglomerative clustering of the species abundance \nlibrary(\"cluster\")\n\n# Compute matrix of chord distance among sites\nspe.norm <- decostand(spe, \"normalize\")\nspe.ch <- vegdist(spe.norm, \"euc\")\n\n# Attach site names to object of class 'dist'\nattr(spe.ch, \"Labels\") <- rownames(spe)\n\npar(mfrow = c(1, 1))\n\n# Compute single linkage agglomerative clustering\nspe.ch.single <- hclust(spe.ch, method = \"single\")\n# Plot a dendrogram using the default options\nplot(spe.ch.single, labels = rownames(spe), main = \"Chord - Single linkage\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Compute complete-linkage agglomerative clustering\nspe.ch.complete <- hclust(spe.ch, method = \"complete\")\nplot(spe.ch.complete, labels = rownames(spe), main = \"Chord - Complete linkage\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-5-2.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Compute UPGMA agglomerative clustering\nspe.ch.UPGMA <- hclust(spe.ch, method = \"average\")\nplot(spe.ch.UPGMA, labels = rownames(spe), main = \"Chord - UPGMA\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-5-3.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Compute centroid clustering\nspe.ch.centroid <- hclust(spe.ch, method = \"centroid\")\nplot(spe.ch.centroid, labels = rownames(spe),  main = \"Chord - Centroid\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-5-4.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Compute Ward's minimum variance clustering\nspe.ch.ward <-hclust(spe.ch, method = \"ward.D2\")\nplot(spe.ch.ward, labels = rownames(spe),  main = \"Chord - Ward\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-5-5.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Compute beta-flexible clustering using cluster::agnes()\n# beta = -0.1\nspe.ch.beta1 <- agnes(spe.ch, method = \"flexible\", par.method = 0.55)\n# beta = -0.25\nspe.ch.beta2 <- agnes(spe.ch, method = \"flexible\", par.method = 0.625)\n# beta = -0.5\nspe.ch.beta3 <- agnes(spe.ch, method = \"flexible\", par.method = 0.75)\n# Change the class of agnes objects\nclass(spe.ch.beta1)\n## [1] \"agnes\" \"twins\"\nspe.ch.beta1 <- as.hclust(spe.ch.beta1)\nclass(spe.ch.beta1)\n## [1] \"hclust\"\nspe.ch.beta2 <- as.hclust(spe.ch.beta2)\nspe.ch.beta3 <- as.hclust(spe.ch.beta3)\n\npar(mfrow = c(2, 2))\nplot(spe.ch.beta1, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.1)\")\nplot(spe.ch.beta2, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.25)\")\nplot(spe.ch.beta3,  labels = rownames(spe),  main = \"Chord - Beta-flexible (beta=-0.5)\")\n\n# Compute Ward's minimum variance clustering\nspe.ch.ward <- hclust(spe.ch, method = \"ward.D2\")\nplot(spe.ch.ward, labels = rownames(spe), main = \"Chord - Ward\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-5-6.png){width=672}\n:::\n:::\n\n\n## Cophenetic correlations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Single linkage clustering\nspe.ch.single.coph <- cophenetic(spe.ch.single)\ncor(spe.ch, spe.ch.single.coph)\n## [1] 0.599193\n\n# Complete linkage clustering\nspe.ch.comp.coph <- cophenetic(spe.ch.complete)\ncor(spe.ch, spe.ch.comp.coph)\n## [1] 0.7655628\n\n# Average clustering\nspe.ch.UPGMA.coph <- cophenetic(spe.ch.UPGMA)\ncor(spe.ch, spe.ch.UPGMA.coph)\n## [1] 0.8608326\n\n# Ward clustering\nspe.ch.ward.coph <- cophenetic(spe.ch.ward)\ncor(spe.ch, spe.ch.ward.coph)\n## [1] 0.7998516\n\n# Shepard-like diagrams\npar(mfrow = c(2, 2))\nplot(spe.ch, spe.ch.single.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, sqrt(2)),\n  main = c(\"Single linkage\", paste(\"Cophenetic correlation =\",\n                                   round(cor(spe.ch, spe.ch.single.coph), 3))))\nabline(0, 1)\nlines(lowess(spe.ch, spe.ch.single.coph), col = \"red\")\n\nplot(spe.ch, spe.ch.comp.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, sqrt(2)),\n  main = c(\"Complete linkage\", paste(\"Cophenetic correlation =\",\n                                     round(cor(spe.ch, spe.ch.comp.coph), 3))))\nabline(0, 1)\nlines(lowess(spe.ch, spe.ch.comp.coph), col = \"red\")\n\nplot(spe.ch, spe.ch.UPGMA.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, sqrt(2)),\n  main = c(\"UPGMA\", paste(\"Cophenetic correlation =\",\n                          round( cor(spe.ch, spe.ch.UPGMA.coph), 3))))\nabline(0, 1)\nlines(lowess(spe.ch, spe.ch.UPGMA.coph), col = \"red\")\n\nplot(spe.ch, spe.ch.ward.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, max(spe.ch.ward$height)),\n  main = c(\"Ward\", paste(\"Cophenetic correlation =\", \n                         round(cor(spe.ch, spe.ch.ward.coph), 3))))\nabline(0, 1)\nlines(lowess(spe.ch, spe.ch.ward.coph), col = \"red\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n## Optimale Anzahl Cluster\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"labdsv\")\n## Select a dendrogram (Ward/chord) and apply three criteria\n## to choose the optimal number of clusters\n\n# Choose and rename the dendrogram (\"hclust\" object)\nhc <- spe.ch.ward\n# hc <- spe.ch.beta2\n# hc <- spe.ch.complete\n\npar(mfrow = c(1, 2))\n\n# Average silhouette widths (Rousseeuw quality index)\nSi <- numeric(nrow(spe))\nfor (k in 2:(nrow(spe) - 1))\n{\n  sil <- silhouette(cutree(hc, k = k), spe.ch)\n  Si[k] <- summary(sil)$avg.width\n}\n\nk.best <- which.max(Si)\nplot(1:nrow(spe), Si, type = \"h\",\n  main = \"Silhouette-optimal number of clusters\",\n  xlab = \"k (number of clusters)\", ylab = \"Average silhouette width\")\naxis(1, k.best,paste(\"optimum\", k.best, sep = \"\\n\"), col = \"red\", \n  font = 2, col.axis = \"red\")\npoints(k.best,max(Si), pch = 16, col = \"red\",cex = 1.5)\n\n# Optimal number of clusters according to matrix correlation \n# statistic (Pearson)\n\n# Homemade function grpdist from Borcard et al. (2018)\ngrpdist <- function(X)\n{\n  require(cluster)\n  veg <- as.data.frame(as.factor(X))\n  distgr <- daisy(veg, \"gower\")\n  distgr\n} \n\nkt <- data.frame(k = 1:nrow(spe), r = 0)\nfor (i in 2:(nrow(spe) - 1)) \n{\n  gr <- cutree(hc, i)\n  distgr <- grpdist(gr)\n  mt <- cor(spe.ch, distgr, method = \"pearson\")\n  kt[i, 2] <- mt\n}\n\nk.best <- which.max(kt$r)\nplot(kt$k,kt$r, type = \"h\",\n  main = \"Matrix correlation-optimal number of clusters\",\n  xlab = \"k (number of clusters)\", ylab = \"Pearson's correlation\")\naxis(1, k.best, paste(\"optimum\", k.best, sep = \"\\n\"),\n  col = \"red\", font = 2, col.axis = \"red\")\npoints(k.best, max(kt$r), pch = 16, col = \"red\", cex = 1.5)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Optimal number of clusters according as per indicator species\n# analysis (IndVal, Dufrene-Legendre; package: labdsv)\nIndVal <- numeric(nrow(spe))\nng <- numeric(nrow(spe))\nfor (k in 2:(nrow(spe) - 1))\n{\n  iva <- indval(spe, cutree(hc, k = k), numitr = 1000)\n  gr <- factor(iva$maxcls[iva$pval <= 0.05])\n  ng[k] <- length(levels(gr)) / k\n  iv <- iva$indcls[iva$pval <= 0.05]\n  IndVal[k] <- sum(iv)\n}\n\nk.best <- which.max(IndVal[ng == 1]) + 1\ncol3 <- rep(1, nrow(spe))\ncol3[ng == 1] <- 3\n\npar(mfrow = c(1, 2))\nplot(1:nrow(spe), IndVal, type = \"h\",\n  main = \"IndVal-optimal number of clusters\",\n  xlab = \"k (number of clusters)\", ylab = \"IndVal sum\", col = col3)\naxis(1,k.best,paste(\"optimum\", k.best, sep = \"\\n\"),\n  col = \"red\", font = 2, col.axis = \"red\")\n\npoints(which.max(IndVal),max(IndVal),pch = 16,col = \"red\",cex = 1.5)\ntext(28, 15.7, \"a\", cex = 1.8)\n\nplot(1:nrow(spe),ng,\n  type = \"h\",\n  xlab = \"k (number of clusters)\",\n  ylab = \"Ratio\",\n  main = \"Proportion of clusters with significant indicator species\",\n  col = col3)\naxis(1,k.best,paste(\"optimum\", k.best, sep = \"\\n\"),\n     col = \"red\", font = 2, col.axis = \"red\")\npoints(k.best,max(ng), pch = 16, col = \"red\", cex = 1.5)\ntext(28, 0.98, \"b\", cex = 1.8)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n:::\n\n\n## Final dendrogram with the selected clusters\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Choose the number of clusters\nk <- 4\n# Silhouette plot of the final partition\nspech.ward.g <- cutree(spe.ch.ward, k = k)\nsil <- silhouette(spech.ward.g, spe.ch)\nrownames(sil) <- row.names(spe)\n\nplot(sil, main = \"Silhouette plot - Chord - Ward\", cex.names = 0.8, col = 2:(k + 1), nmax = 100)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Reorder clusters\nlibrary(\"gclus\")\nspe.chwo <- reorder.hclust(spe.ch.ward, spe.ch)\n\n# Plot reordered dendrogram with group labels\npar(mfrow = c(1, 1))\nplot(spe.chwo, hang = -1, xlab = \"4 groups\", ylab = \"Height\", sub = \"\",\n  main = \"Chord - Ward (reordered)\", labels = cutree(spe.chwo, k = k))\nrect.hclust(spe.chwo, k = k)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-8-2.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Plot the final dendrogram with group colors (RGBCMY...)\n# Fast method using the additional hcoplot() function:\n# Usage:\n# hcoplot(tree = hclust.object,\n#   diss = dissimilarity.matrix,\n#   lab = object labels (default NULL),\n#   k = nb.clusters,\n#   title = paste(\"Reordered dendrogram from\",deparse(tree$call),\n#   sep=\"\\n\"))\nsource(\"stat5-8/hcoplot.R\")\nhcoplot(spe.ch.ward, spe.ch, lab = rownames(spe), k = 4)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-8-3.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Plot the Ward clusters on a map of the Doubs River\n# (see Chapter 2)\nsource(\"stat5-8/drawmap.R\")\ndrawmap(xy = spa, clusters = spech.ward.g, main = \"Four Ward clusters along the Doubs River\")\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-8-4.png){width=672}\n:::\n:::\n\n\n## Miscellaneous graphical outputs\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# konvertieren von \"hclust\" Objekt in ein Dendogram Objekt\ndend <- as.dendrogram(spe.ch.ward)\n\n# Heat map of the dissimilarity matrix ordered with the dendrogram\nheatmap(as.matrix(spe.ch), Rowv = dend, symm = TRUE, margin = c(3, 3))\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Ordered community table\n# Species are ordered by their weighted averages on site scores.\n# Dots represent absences.\nlibrary(\"vegan\")\nor <- vegemite(spe, spe.chwo)\n##                                    \n##       32222222222  111111     1111 \n##       09876210543959876506473221341\n##  Icme 5432121......................\n##  Abbr 54332431.....1...............\n##  Blbj 54542432.1...1...............\n##  Anan 54432222.....111.............\n##  Gyce 5555443212...11..............\n##  Scer 522112221...21...............\n##  Cyca 53421321.....1111............\n##  Rham 55432333.....221.............\n##  Legi 35432322.1...1111............\n##  Alal 55555555352..322.............\n##  Chna 12111322.1...211.............\n##  Titi 53453444...1321111.21........\n##  Ruru 55554555121455221..1.........\n##  Albi 53111123.....2341............\n##  Baba 35342544.....23322.........1.\n##  Eslu 453423321...41111..12.1....1.\n##  Gogo 5544355421..242122111......1.\n##  Pefl 54211432....41321..12........\n##  Pato 2211.222.....3344............\n##  Sqce 3443242312152132232211..11.1.\n##  Lele 332213221...52235321.1.......\n##  Babl .1111112...32534554555534124.\n##  Teso .1...........11254........23.\n##  Phph .1....11...13334344454544455.\n##  Cogo ..............1123......2123.\n##  Satr .1..........2.123413455553553\n##  Thth .1............11.2......2134.\n## 29 sites, 27 species\n```\n:::\n",
    "supporting": [
      "Statistik8_Demo_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}