{
  "hash": "a3832cd2191c1afb5c4c41f7068df3e0",
  "result": {
    "markdown": "---\ndate: 2023-11-21\nlesson: Stat8\nthema: Clusteranalysen\nindex: 1\nformat:\n  html:\n    code-tools:\n      source: true\n---\n\n\n# Stat8: Demo\n\n-   Download dieses Demoscript via \"\\</\\>Code\" (oben rechts)\n-   Datensatz *Doubs.RData*\n-   Funktion drawmap.R [drawmap.R](drawmap.R)\n-   Funktion hcoplot.R [hcoplot.R](hcoplot.R)\n\n## k-means clustering\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Das Moordatenset sveg laden\nlibrary(\"dave\")\n## Error in library(\"dave\"): there is no package called 'dave'\n\n# PCA und CA rechnen\npca <- rda(sveg^0.25, scale = TRUE)\n## Error in rda(sveg^0.25, scale = TRUE): could not find function \"rda\"\nca <- cca(sveg^0.5)\n## Error in cca(sveg^0.5): could not find function \"cca\"\n\n# k-means-Clustering mit 4 Gruppen durchfÃ¼hren\nkmeans.1 <- kmeans(sveg, 4)\n## Error in as.matrix(x): object 'sveg' not found\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Clustering-Resultat in Ordinationsplots darstellen\nplot(ca, type = \"n\")\n## Error in plot(ca, type = \"n\"): object 'ca' not found\npoints(ca, display = \"sites\", pch=19, col = kmeans.1[[1]])\n## Error in points(ca, display = \"sites\", pch = 19, col = kmeans.1[[1]]): object 'ca' not found\n\n# k-means Clustering mit 3 Clusters\nkmeans.2 <- kmeans(sveg, 3)\n## Error in as.matrix(x): object 'sveg' not found\nplot(pca, type = \"n\")\n## Error in plot(pca, type = \"n\"): object 'pca' not found\npoints(pca, display = \"sites\", pch=19, col = kmeans.2[[1]])\n## Error in points(pca, display = \"sites\", pch = 19, col = kmeans.2[[1]]): object 'pca' not found\n\n# mit 3. Achse darstellen\nplot(pca, choices = c(1, 3), type = \"n\")\n## Error in plot(pca, choices = c(1, 3), type = \"n\"): object 'pca' not found\npoints(pca, choices = c(1, 3), display = \"sites\", pch = 19, col=kmeans.2[[1]])\n## Error in points(pca, choices = c(1, 3), display = \"sites\", pch = 19, col = kmeans.2[[1]]): object 'pca' not found\n\n# k-means partitioning, 2 to 10 groups\nKM.cascade <- cascadeKM(sveg,  inf.gr = 2, sup.gr = 10, iter = 100, criterion = \"ssi\")\n## Error in cascadeKM(sveg, inf.gr = 2, sup.gr = 10, iter = 100, criterion = \"ssi\"): could not find function \"cascadeKM\"\nsummary(KM.cascade)\n## Error in summary(KM.cascade): object 'KM.cascade' not found\nKM.cascade$results\n## Error in eval(expr, envir, enclos): object 'KM.cascade' not found\nKM.cascade$partition\n## Error in eval(expr, envir, enclos): object 'KM.cascade' not found\n\n# k-means visualisation\nplot(KM.cascade, sortg = TRUE)\n## Error in plot(KM.cascade, sortg = TRUE): object 'KM.cascade' not found\n```\n:::\n\n\n## Agglomarative Clusteranalyse\n\nmit Daten und Skripten aus @borcard2011\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Daten laden\nload(\"datasets/stat5-8/Doubs.RData\")  \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Remove empty site 8\nspe <- spe[-8, ]\nenv <- env[-8, ]\nspa <- spa[-8, ]\nlatlong <- latlong[-8, ]\n```\n:::\n\n\n## Dendogramme berechnen und ploten\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Hierarchical agglomerative clustering of the species abundance \n\n# Compute matrix of chord distance among sites\nspe.norm <- decostand(spe, \"normalize\")\n## Error in decostand(spe, \"normalize\"): could not find function \"decostand\"\nspe.ch <- vegdist(spe.norm, \"euc\")\n## Error in vegdist(spe.norm, \"euc\"): could not find function \"vegdist\"\n\n# Attach site names to object of class 'dist'\nattr(spe.ch, \"Labels\") <- rownames(spe)\n## Error in attr(spe.ch, \"Labels\") <- rownames(spe): object 'spe.ch' not found\n\npar(mfrow = c(1, 1))\n\n# Compute single linkage agglomerative clustering\nspe.ch.single <- hclust(spe.ch, method = \"single\")\n## Error in hclust(spe.ch, method = \"single\"): object 'spe.ch' not found\n# Plot a dendrogram using the default options\nplot(spe.ch.single, labels = rownames(spe), main = \"Chord - Single linkage\")\n## Error in plot(spe.ch.single, labels = rownames(spe), main = \"Chord - Single linkage\"): object 'spe.ch.single' not found\n\n# Compute complete-linkage agglomerative clustering\nspe.ch.complete <- hclust(spe.ch, method = \"complete\")\n## Error in hclust(spe.ch, method = \"complete\"): object 'spe.ch' not found\nplot(spe.ch.complete, labels = rownames(spe), main = \"Chord - Complete linkage\")\n## Error in plot(spe.ch.complete, labels = rownames(spe), main = \"Chord - Complete linkage\"): object 'spe.ch.complete' not found\n\n# Compute UPGMA agglomerative clustering\nspe.ch.UPGMA <- hclust(spe.ch, method = \"average\")\n## Error in hclust(spe.ch, method = \"average\"): object 'spe.ch' not found\nplot(spe.ch.UPGMA, labels = rownames(spe), main = \"Chord - UPGMA\")\n## Error in plot(spe.ch.UPGMA, labels = rownames(spe), main = \"Chord - UPGMA\"): object 'spe.ch.UPGMA' not found\n\n# Compute centroid clustering\nspe.ch.centroid <- hclust(spe.ch, method = \"centroid\")\n## Error in hclust(spe.ch, method = \"centroid\"): object 'spe.ch' not found\nplot(spe.ch.centroid, labels = rownames(spe),  main = \"Chord - Centroid\")\n## Error in plot(spe.ch.centroid, labels = rownames(spe), main = \"Chord - Centroid\"): object 'spe.ch.centroid' not found\n\n# Compute Ward's minimum variance clustering\nspe.ch.ward <-hclust(spe.ch, method = \"ward.D2\")\n## Error in hclust(spe.ch, method = \"ward.D2\"): object 'spe.ch' not found\nplot(spe.ch.ward, labels = rownames(spe),  main = \"Chord - Ward\")\n## Error in plot(spe.ch.ward, labels = rownames(spe), main = \"Chord - Ward\"): object 'spe.ch.ward' not found\n\n# Compute beta-flexible clustering using cluster::agnes()\n# beta = -0.1\nspe.ch.beta1 <- agnes(spe.ch, method = \"flexible\", par.method = 0.55)\n## Error in agnes(spe.ch, method = \"flexible\", par.method = 0.55): could not find function \"agnes\"\n# beta = -0.25\nspe.ch.beta2 <- agnes(spe.ch, method = \"flexible\", par.method = 0.625)\n## Error in agnes(spe.ch, method = \"flexible\", par.method = 0.625): could not find function \"agnes\"\n# beta = -0.5\nspe.ch.beta3 <- agnes(spe.ch, method = \"flexible\", par.method = 0.75)\n## Error in agnes(spe.ch, method = \"flexible\", par.method = 0.75): could not find function \"agnes\"\n# Change the class of agnes objects\nclass(spe.ch.beta1)\n## Error in eval(expr, envir, enclos): object 'spe.ch.beta1' not found\nspe.ch.beta1 <- as.hclust(spe.ch.beta1)\n## Error in as.hclust(spe.ch.beta1): object 'spe.ch.beta1' not found\nclass(spe.ch.beta1)\n## Error in eval(expr, envir, enclos): object 'spe.ch.beta1' not found\nspe.ch.beta2 <- as.hclust(spe.ch.beta2)\n## Error in as.hclust(spe.ch.beta2): object 'spe.ch.beta2' not found\nspe.ch.beta3 <- as.hclust(spe.ch.beta3)\n## Error in as.hclust(spe.ch.beta3): object 'spe.ch.beta3' not found\n\npar(mfrow = c(2, 2))\nplot(spe.ch.beta1, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.1)\")\n## Error in plot(spe.ch.beta1, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.1)\"): object 'spe.ch.beta1' not found\nplot(spe.ch.beta2, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.25)\")\n## Error in plot(spe.ch.beta2, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.25)\"): object 'spe.ch.beta2' not found\nplot(spe.ch.beta3,  labels = rownames(spe),  main = \"Chord - Beta-flexible (beta=-0.5)\")\n## Error in plot(spe.ch.beta3, labels = rownames(spe), main = \"Chord - Beta-flexible (beta=-0.5)\"): object 'spe.ch.beta3' not found\n\n# Compute Ward's minimum variance clustering\nspe.ch.ward <- hclust(spe.ch, method = \"ward.D2\")\n## Error in hclust(spe.ch, method = \"ward.D2\"): object 'spe.ch' not found\nplot(spe.ch.ward, labels = rownames(spe), main = \"Chord - Ward\")\n## Error in plot(spe.ch.ward, labels = rownames(spe), main = \"Chord - Ward\"): object 'spe.ch.ward' not found\n```\n:::\n\n\n## Cophenetic correlations\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Single linkage clustering\nspe.ch.single.coph <- cophenetic(spe.ch.single)\n## Error in cophenetic(spe.ch.single): object 'spe.ch.single' not found\ncor(spe.ch, spe.ch.single.coph)\n## Error in is.data.frame(y): object 'spe.ch.single.coph' not found\n\n# Complete linkage clustering\nspe.ch.comp.coph <- cophenetic(spe.ch.complete)\n## Error in cophenetic(spe.ch.complete): object 'spe.ch.complete' not found\ncor(spe.ch, spe.ch.comp.coph)\n## Error in is.data.frame(y): object 'spe.ch.comp.coph' not found\n\n# Average clustering\nspe.ch.UPGMA.coph <- cophenetic(spe.ch.UPGMA)\n## Error in cophenetic(spe.ch.UPGMA): object 'spe.ch.UPGMA' not found\ncor(spe.ch, spe.ch.UPGMA.coph)\n## Error in is.data.frame(y): object 'spe.ch.UPGMA.coph' not found\n\n# Ward clustering\nspe.ch.ward.coph <- cophenetic(spe.ch.ward)\n## Error in cophenetic(spe.ch.ward): object 'spe.ch.ward' not found\ncor(spe.ch, spe.ch.ward.coph)\n## Error in is.data.frame(y): object 'spe.ch.ward.coph' not found\n\n# Shepard-like diagrams\npar(mfrow = c(2, 2))\nplot(spe.ch, spe.ch.single.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, sqrt(2)),\n  main = c(\"Single linkage\", paste(\"Cophenetic correlation =\",\n                                   round(cor(spe.ch, spe.ch.single.coph), 3))))\n## Error in plot(spe.ch, spe.ch.single.coph, xlab = \"Chord distance\", ylab = \"Cophenetic distance\", : object 'spe.ch' not found\nabline(0, 1)\n## Error in int_abline(a = a, b = b, h = h, v = v, untf = untf, ...): plot.new has not been called yet\nlines(lowess(spe.ch, spe.ch.single.coph), col = \"red\")\n## Error in xy.coords(x, y, setLab = FALSE): object 'spe.ch.single.coph' not found\n\nplot(spe.ch, spe.ch.comp.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, sqrt(2)),\n  main = c(\"Complete linkage\", paste(\"Cophenetic correlation =\",\n                                     round(cor(spe.ch, spe.ch.comp.coph), 3))))\n## Error in plot(spe.ch, spe.ch.comp.coph, xlab = \"Chord distance\", ylab = \"Cophenetic distance\", : object 'spe.ch' not found\nabline(0, 1)\n## Error in int_abline(a = a, b = b, h = h, v = v, untf = untf, ...): plot.new has not been called yet\nlines(lowess(spe.ch, spe.ch.comp.coph), col = \"red\")\n## Error in xy.coords(x, y, setLab = FALSE): object 'spe.ch.comp.coph' not found\n\nplot(spe.ch, spe.ch.UPGMA.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, sqrt(2)),\n  main = c(\"UPGMA\", paste(\"Cophenetic correlation =\",\n                          round( cor(spe.ch, spe.ch.UPGMA.coph), 3))))\n## Error in plot(spe.ch, spe.ch.UPGMA.coph, xlab = \"Chord distance\", ylab = \"Cophenetic distance\", : object 'spe.ch' not found\nabline(0, 1)\n## Error in int_abline(a = a, b = b, h = h, v = v, untf = untf, ...): plot.new has not been called yet\nlines(lowess(spe.ch, spe.ch.UPGMA.coph), col = \"red\")\n## Error in xy.coords(x, y, setLab = FALSE): object 'spe.ch.UPGMA.coph' not found\n\nplot(spe.ch, spe.ch.ward.coph,\n  xlab = \"Chord distance\", ylab = \"Cophenetic distance\",\n  asp = 1, xlim = c(0, sqrt(2)), ylim = c(0, max(spe.ch.ward$height)),\n  main = c(\"Ward\", paste(\"Cophenetic correlation =\", \n                         round(cor(spe.ch, spe.ch.ward.coph), 3))))\n## Error in plot(spe.ch, spe.ch.ward.coph, xlab = \"Chord distance\", ylab = \"Cophenetic distance\", : object 'spe.ch' not found\nabline(0, 1)\n## Error in int_abline(a = a, b = b, h = h, v = v, untf = untf, ...): plot.new has not been called yet\nlines(lowess(spe.ch, spe.ch.ward.coph), col = \"red\")\n## Error in xy.coords(x, y, setLab = FALSE): object 'spe.ch.ward.coph' not found\n```\n:::\n\n\n## Optimale Anzahl Cluster\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Select a dendrogram (Ward/chord) and apply three criteria\n## to choose the optimal number of clusters\n\n# Choose and rename the dendrogram (\"hclust\" object)\nhc <- spe.ch.ward\n## Error in eval(expr, envir, enclos): object 'spe.ch.ward' not found\n# hc <- spe.ch.beta2\n# hc <- spe.ch.complete\n\npar(mfrow = c(1, 2))\n\n# Average silhouette widths (Rousseeuw quality index)\nSi <- numeric(nrow(spe))\nfor (k in 2:(nrow(spe) - 1))\n{\n  sil <- silhouette(cutree(hc, k = k), spe.ch)\n  Si[k] <- summary(sil)$avg.width\n}\n## Error in silhouette(cutree(hc, k = k), spe.ch): could not find function \"silhouette\"\n\nk.best <- which.max(Si)\nplot(1:nrow(spe), Si, type = \"h\",\n  main = \"Silhouette-optimal number of clusters\",\n  xlab = \"k (number of clusters)\", ylab = \"Average silhouette width\")\naxis(1, k.best,paste(\"optimum\", k.best, sep = \"\\n\"), col = \"red\", \n  font = 2, col.axis = \"red\")\npoints(k.best,max(Si), pch = 16, col = \"red\",cex = 1.5)\n\n# Optimal number of clusters according to matrix correlation \n# statistic (Pearson)\n\n# Homemade function grpdist from Borcard et al. (2018)\ngrpdist <- function(X)\n{\n  require(cluster)\n  veg <- as.data.frame(as.factor(X))\n  distgr <- daisy(veg, \"gower\")\n  distgr\n} \n\nkt <- data.frame(k = 1:nrow(spe), r = 0)\nfor (i in 2:(nrow(spe) - 1)) \n{\n  gr <- cutree(hc, i)\n  distgr <- grpdist(gr)\n  mt <- cor(spe.ch, distgr, method = \"pearson\")\n  kt[i, 2] <- mt\n}\n## Error in cutree(hc, i): object 'hc' not found\n\nk.best <- which.max(kt$r)\nplot(kt$k,kt$r, type = \"h\",\n  main = \"Matrix correlation-optimal number of clusters\",\n  xlab = \"k (number of clusters)\", ylab = \"Pearson's correlation\")\naxis(1, k.best, paste(\"optimum\", k.best, sep = \"\\n\"),\n  col = \"red\", font = 2, col.axis = \"red\")\npoints(k.best, max(kt$r), pch = 16, col = \"red\", cex = 1.5)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n# Optimal number of clusters according as per indicator species\n# analysis (IndVal, Dufrene-Legendre; package: labdsv)\nIndVal <- numeric(nrow(spe))\nng <- numeric(nrow(spe))\nfor (k in 2:(nrow(spe) - 1))\n{\n  iva <- indval(spe, cutree(hc, k = k), numitr = 1000)\n  gr <- factor(iva$maxcls[iva$pval <= 0.05])\n  ng[k] <- length(levels(gr)) / k\n  iv <- iva$indcls[iva$pval <= 0.05]\n  IndVal[k] <- sum(iv)\n}\n## Error in indval(spe, cutree(hc, k = k), numitr = 1000): could not find function \"indval\"\n\nk.best <- which.max(IndVal[ng == 1]) + 1\ncol3 <- rep(1, nrow(spe))\ncol3[ng == 1] <- 3\n\npar(mfrow = c(1, 2))\nplot(1:nrow(spe), IndVal, type = \"h\",\n  main = \"IndVal-optimal number of clusters\",\n  xlab = \"k (number of clusters)\", ylab = \"IndVal sum\", col = col3)\naxis(1,k.best,paste(\"optimum\", k.best, sep = \"\\n\"),\n  col = \"red\", font = 2, col.axis = \"red\")\n## Error in axis(1, k.best, paste(\"optimum\", k.best, sep = \"\\n\"), col = \"red\", : 'at' and 'labels' lengths differ, 0 != 1\n\npoints(which.max(IndVal),max(IndVal),pch = 16,col = \"red\",cex = 1.5)\ntext(28, 15.7, \"a\", cex = 1.8)\n\nplot(1:nrow(spe),ng,\n  type = \"h\",\n  xlab = \"k (number of clusters)\",\n  ylab = \"Ratio\",\n  main = \"Proportion of clusters with significant indicator species\",\n  col = col3)\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-7-2.png){width=672}\n:::\n\n```{.r .cell-code}\naxis(1,k.best,paste(\"optimum\", k.best, sep = \"\\n\"),\n     col = \"red\", font = 2, col.axis = \"red\")\n## Error in axis(1, k.best, paste(\"optimum\", k.best, sep = \"\\n\"), col = \"red\", : 'at' and 'labels' lengths differ, 0 != 1\npoints(k.best,max(ng), pch = 16, col = \"red\", cex = 1.5)\n## Error in xy.coords(x, y): 'x' and 'y' lengths differ\ntext(28, 0.98, \"b\", cex = 1.8)\n```\n:::\n\n\n## Final dendrogram with the selected clusters\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Choose the number of clusters\nk <- 4\n# Silhouette plot of the final partition\nspech.ward.g <- cutree(spe.ch.ward, k = k)\n## Error in nrow(tree$merge): object 'spe.ch.ward' not found\nsil <- silhouette(spech.ward.g, spe.ch)\n## Error in silhouette(spech.ward.g, spe.ch): could not find function \"silhouette\"\nrownames(sil) <- row.names(spe)\n## Error in rownames(sil) <- row.names(spe): object 'sil' not found\n\nplot(sil, main = \"Silhouette plot - Chord - Ward\", cex.names = 0.8, col = 2:(k + 1), nmax = 100)\n## Error in plot(sil, main = \"Silhouette plot - Chord - Ward\", cex.names = 0.8, : object 'sil' not found\n\n# Reorder clusters\nlibrary(\"gclus\")\n## Error in library(\"gclus\"): there is no package called 'gclus'\nspe.chwo <- reorder.hclust(spe.ch.ward, spe.ch)\n## Error in reorder.hclust(spe.ch.ward, spe.ch): could not find function \"reorder.hclust\"\n\n# Plot reordered dendrogram with group labels\npar(mfrow = c(1, 1))\nplot(spe.chwo, hang = -1, xlab = \"4 groups\", ylab = \"Height\", sub = \"\",\n  main = \"Chord - Ward (reordered)\", labels = cutree(spe.chwo, k = k))\n## Error in plot(spe.chwo, hang = -1, xlab = \"4 groups\", ylab = \"Height\", : object 'spe.chwo' not found\nrect.hclust(spe.chwo, k = k)\n## Error in rect.hclust(spe.chwo, k = k): object 'spe.chwo' not found\n\n# Plot the final dendrogram with group colors (RGBCMY...)\n# Fast method using the additional hcoplot() function:\n# Usage:\n# hcoplot(tree = hclust.object,\n#   diss = dissimilarity.matrix,\n#   lab = object labels (default NULL),\n#   k = nb.clusters,\n#   title = paste(\"Reordered dendrogram from\",deparse(tree$call),\n#   sep=\"\\n\"))\nsource(\"stat5-8/hcoplot.R\")\nhcoplot(spe.ch.ward, spe.ch, lab = rownames(spe), k = 4)\n## Error in nrow(tree$merge): object 'spe.ch.ward' not found\n\n# Plot the Ward clusters on a map of the Doubs River\n# (see Chapter 2)\nsource(\"stat5-8/drawmap.R\")\ndrawmap(xy = spa, clusters = spech.ward.g, main = \"Four Ward clusters along the Doubs River\")\n## Error in factor(clusters): object 'spech.ward.g' not found\n```\n\n::: {.cell-output-display}\n![](Statistik8_Demo_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Miscellaneous graphical outputs\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# konvertieren von \"hclust\" Objekt in ein Dendogram Objekt\ndend <- as.dendrogram(spe.ch.ward)\n## Error in as.dendrogram(spe.ch.ward): object 'spe.ch.ward' not found\n\n# Heat map of the dissimilarity matrix ordered with the dendrogram\nheatmap(as.matrix(spe.ch), Rowv = dend, symm = TRUE, margin = c(3, 3))\n## Error in as.matrix(spe.ch): object 'spe.ch' not found\n\n# Ordered community table\n# Species are ordered by their weighted averages on site scores.\n# Dots represent absences.\nlibrary(\"vegan\")\nor <- vegemite(spe, spe.chwo)\n## Error in vegemite(spe, spe.chwo): object 'spe.chwo' not found\n```\n:::\n",
    "supporting": [
      "Statistik8_Demo_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}